<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">海子诗歌</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @font-face {
            font-family: 'LXGWWenKai';
            src: url('./LXGWWenKai-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        :root {
            --poem-font: 'LXGWWenKai', 'Noto Serif SC', Georgia, serif;
            --ui-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }

        body {
            font-family: var(--ui-font);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .poem-font {
            font-family: var(--poem-font);
        }

        .poem-content {
            white-space: pre-line;
            line-height: 2;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-bg {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 背景图片 -->
    <div class="fixed inset-0 z-0">
        <img src="assets/images/image-haizi.jpg" alt="海子" class="w-full h-full object-cover opacity-20 grayscale">
        <div class="absolute inset-0 bg-gradient-to-b from-gray-50/30 via-gray-50/50 to-gray-50/30"></div>
    </div>

    <!-- 导航栏 -->
    <nav class="relative z-10 glass-bg border-b border-white/20">
        <div class="max-w-4xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <a href="index.html" class="flex items-center text-gray-700 hover:text-gray-900 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m0 0v14"></path>
                    </svg>
                    返回诗集
                </a>
                <h1 class="text-lg font-medium text-gray-800 poem-font">海子诗歌集</h1>
                <div class="w-20"></div> <!-- 占位保持居中 -->
            </div>
        </div>
    </nav>

    <!-- 加载状态 -->
    <div id="loading" class="relative z-10 flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="loading-spinner w-8 h-8 border-2 border-gray-300 border-t-gray-600 rounded-full mx-auto mb-4"></div>
            <p class="text-gray-600">正在加载诗歌...</p>
        </div>
    </div>

    <!-- 诗歌内容 -->
    <main id="poem-container" class="relative z-10 hidden">
        <div class="max-w-4xl mx-auto px-6 py-12">
            <!-- 诗歌卡片 -->
            <article class="glass-bg rounded-2xl shadow-xl overflow-hidden fade-in">
                <!-- 诗歌标题区域 -->
                <div class="relative h-64 flex items-center justify-center text-white">
                    <img id="poem-image" src="assets/images/image-haizi.jpg" alt="" class="absolute inset-0 w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/60"></div>
                    <div class="relative text-center">
                        <h1 id="poem-title" class="text-4xl md:text-5xl font-bold mb-4 poem-font drop-shadow-2xl">
                            诗歌标题
                        </h1>
                        <div class="flex justify-center mb-4">
                            <div class="w-24 h-px bg-white/80"></div>
                        </div>
                        <p id="poem-meta" class="text-lg opacity-90 drop-shadow">海子</p>
                    </div>
                </div>

                <!-- 诗歌正文 -->
                <div class="p-8 md:p-12">
                    <div id="poem-content" class="poem-content poem-font text-gray-800 text-lg md:text-xl leading-relaxed mb-8 text-center max-w-2xl mx-auto">
                        <!-- 诗歌内容将在这里渲染 -->
                    </div>

                    <!-- 诗歌信息 -->
                    <div id="poem-info" class="border-t border-gray-200 pt-6 text-sm text-gray-600 space-y-2">
                        <!-- 诗歌元信息将在这里显示 -->
                    </div>
                </div>
            </article>

            <!-- 导航按钮 -->
            <div class="flex justify-between items-center mt-8">
                <button id="prev-poem" class="glass-bg px-6 py-3 rounded-full text-gray-700 hover:text-gray-900 transition-all duration-300 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        上一首
                    </span>
                </button>

                <a href="index.html" class="glass-bg px-6 py-3 rounded-full text-gray-700 hover:text-gray-900 transition-all duration-300 hover:shadow-lg">
                    诗集目录
                </a>

                <button id="next-poem" class="glass-bg px-6 py-3 rounded-full text-gray-700 hover:text-gray-900 transition-all duration-300 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="flex items-center">
                        下一首
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </main>

    <!-- 错误状态 -->
    <div id="error" class="relative z-10 hidden">
        <div class="max-w-4xl mx-auto px-6 py-12 text-center">
            <div class="glass-bg rounded-2xl p-12">
                <div class="text-red-500 mb-4">
                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">诗歌加载失败</h2>
                <p class="text-gray-600 mb-6">抱歉，无法找到或加载这首诗歌。</p>
                <a href="index.html" class="inline-flex items-center px-6 py-3 bg-gray-800 text-white rounded-full hover:bg-gray-700 transition-colors">
                    返回诗集目录
                </a>
            </div>
        </div>
    </div>

    <script src="assets/js/poems-data.js"></script>
    <script>
        class PoemRenderer {
            constructor() {
                this.init();
            }

            async init() {
                // 从URL参数获取诗歌文件路径
                const urlParams = new URLSearchParams(window.location.search);
                const poemPath = urlParams.get('poem');
                
                if (!poemPath) {
                    this.showError('没有指定诗歌文件');
                    return;
                }

                // 加载指定诗歌
                await this.loadPoem(poemPath);
            }

            async loadPoemsList() {
                try {
                    // 从全局诗歌数据加载列表
                    if (typeof poemsData !== 'undefined') {
                        this.poems = poemsData.map(poem => `assets/content/poems/${poem.path}`);
                    } else {
                        throw new Error('诗歌数据未加载');
                    }
                } catch (error) {
                    console.error('加载诗歌列表失败:', error);
                    this.poems = [];
                }
            }

            async loadPoem(poemPath) {
                try {
                    // 从诗歌数据中查找对应的诗歌
                    const poem = poemsData.find(p => p.path === poemPath);
                    if (!poem) {
                        throw new Error('找不到指定的诗歌');
                    }

                    // 构建完整的文件路径
                    const fullPath = poemPath.startsWith('assets/') ? poemPath : `assets/content/poems/${poemPath}`;
                    
                    try {
                        const response = await fetch(fullPath);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const markdown = await response.text();
                        this.renderPoem(markdown, poemPath, poem);
                    } catch (fetchError) {
                        // 如果无法加载MD文件，使用诗歌数据中的信息创建内容
                        console.warn('无法加载MD文件，使用预览数据:', fetchError);
                        this.renderPoemFromData(poem);
                    }
                    
                    this.updateNavigation();
                    
                } catch (error) {
                    console.error('加载诗歌失败:', error);
                    this.showError(`无法加载诗歌: ${error.message}`);
                }
            }

            renderPoem(markdown, poemPath, poemData) {
                // 解析markdown
                const lines = markdown.split('\n');
                
                // 提取标题（第一行的#标题）
                let title = poemData ? poemData.title : '未知诗歌';
                let content = '';
                let meta = {};
                
                let contentStarted = false;
                let inMetaSection = false;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line.startsWith('# ')) {
                        title = line.substring(2);
                        contentStarted = true;
                        continue;
                    }
                    
                    if (line === '---') {
                        if (contentStarted) {
                            inMetaSection = true;
                            continue;
                        }
                    }
                    
                    if (inMetaSection) {
                        if (line.startsWith('**') && line.includes('**:')) {
                            const [key, value] = line.split('**:');
                            const cleanKey = key.replace(/\*\*/g, '').trim();
                            const cleanValue = value.trim();
                            meta[cleanKey] = cleanValue;
                        }
                        continue;
                    }
                    
                    if (contentStarted && !inMetaSection && line) {
                        content += line + '\n';
                    }
                }
                
                this.displayPoem(title, content.trim(), meta, poemData);
            }

            renderPoemFromData(poemData) {
                // 使用诗歌数据渲染（fallback方案）
                const title = poemData.title;
                const content = poemData.full_content || poemData.preview || '暂无内容';
                const meta = {};
                
                if (poemData.date) {
                    meta['创作时间'] = poemData.date;
                }
                
                if (poemData.url) {
                    meta['原文链接'] = poemData.url;
                }
                
                this.displayPoem(title, content, meta, poemData);
            }

            displayPoem(title, content, meta, poemData) {
                // 更新页面内容
                document.getElementById('page-title').textContent = `${title} - 海子诗歌集`;
                document.getElementById('poem-title').textContent = title;
                document.getElementById('poem-content').textContent = content;
                
                // 更新元信息
                const infoContainer = document.getElementById('poem-info');
                infoContainer.innerHTML = '';
                
                if (poemData && poemData.section) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.innerHTML = `<strong>章节:</strong> ${poemData.section}`;
                    infoContainer.appendChild(sectionDiv);
                }
                
                Object.entries(meta).forEach(([key, value]) => {
                    if (key !== '章节') { // 避免重复显示章节
                        const div = document.createElement('div');
                        if (key === '原文链接' && value.startsWith('http')) {
                            div.innerHTML = `<strong>${key}:</strong> <a href="${value}" target="_blank" class="text-blue-600 hover:text-blue-800">${value}</a>`;
                        } else {
                            div.innerHTML = `<strong>${key}:</strong> ${value}`;
                        }
                        infoContainer.appendChild(div);
                    }
                });
                
                // 显示内容，隐藏加载状态
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('poem-container').classList.remove('hidden');
            }

            updateNavigation() {
                const prevBtn = document.getElementById('prev-poem');
                const nextBtn = document.getElementById('next-poem');
                
                // 使用poemsData而不是this.poems来确定导航
                const currentIndex = this.getCurrentPoemIndex();
                
                prevBtn.disabled = currentIndex <= 0;
                nextBtn.disabled = currentIndex >= poemsData.length - 1;
                
                prevBtn.onclick = () => this.navigateToPoem(currentIndex - 1);
                nextBtn.onclick = () => this.navigateToPoem(currentIndex + 1);
            }

            getCurrentPoemIndex() {
                const urlParams = new URLSearchParams(window.location.search);
                const currentPath = urlParams.get('poem');
                return poemsData.findIndex(poem => poem.path === currentPath);
            }

            navigateToPoem(index) {
                if (index >= 0 && index < poemsData.length) {
                    const poem = poemsData[index];
                    window.location.href = `poem.html?poem=${encodeURIComponent(poem.path)}`;
                }
            }

            showError(message) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                console.error('错误:', message);
            }
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            new PoemRenderer();
        });
    </script>
</body>
</html>